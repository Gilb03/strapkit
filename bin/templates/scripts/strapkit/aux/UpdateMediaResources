#!/usr/bin/env python
import re
import sys
import json
import subprocess

#TODO: recursively add meadia resources.
#TODO: add support for font type detection. eg: .ttf is of type font

# code.py path/to/appinfo.json path/to/images path/to/fonts
# Adds objects with the following structure to appinfo.json['resources']['media']
# {
# 	"type": "png",
# 	"name": "IMAGE_TILE_SPLASH",
# 	"file": "images/tile_splash.png"
# }

def read_appinfo(appInfoFile):
	appInfo = {}
	with open(appInfoFile,'r') as infile:
		appInfo = json.load(infile)
	return appInfo

def write_appinfo(appInfoFile,appInfo):
	with open(appInfoFile,'w') as outfile:
		# json.dump(appInfo,outfile)
		prettyAppInfo = json.dumps(appInfo, sort_keys=True, indent=4, separators=(',', ': '))
		outfile.write(prettyAppInfo)		

def dedup(appInfo,fileEntries):
	media = {}
	appInfoMedia = appInfo['resources']['media']
	for item in appInfoMedia:
		media[item['name']] = item
	
	newMedia = {}
	for item in fileEntries:
		newMedia[item['name']] = item

	deduped = []
	for key in newMedia:
		if key not in media.keys():
			deduped.append(newMedia[key])
	return deduped

def write_media_to_appinfo(fileEntries,appInfoFile):
	appInfo = read_appinfo(appInfoFile)
	uniqFileEntries = dedup(appInfo,fileEntries)
	for fileEntry in uniqFileEntries:
		appInfo['resources']['media'].append(fileEntry)
	write_appinfo(appInfoFile,appInfo)
	return appInfo

def read_media_from_disk(dirs):
	fileEntries = []
	for folder in dirs:
		dirContents = subprocess.check_output(['ls',folder])
		if dirContents:
			files = dirContents.split()
			for fileName in files:
				ext = ''
				match = re.search(r'(.+?)\.(\w+?$)',fileName)
				if match:
					fileName = match.group(1).upper()
					ext = match.group(2)
				fileRelPath = folder+'/'+fileName
				path = subprocess.check_output(['readlink','-f',fileRelPath]).rstrip()
				fileEntry = {"type": ext, "name": fileName, "file": path}
				fileEntries.append(fileEntry)
	return fileEntries

if '__main__' == __name__:
	appInfoFile = sys.argv[1]
	imagesFile = sys.argv[2]
	fontsFile = sys.argv[3]

	fileEntries = read_media_from_disk([imagesFile,fontsFile])
	write_media_to_appinfo(fileEntries,appInfoFile)