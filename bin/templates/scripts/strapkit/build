#!/bin/bash

# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
# 
# http://www.apache.org/licenses/LICENSE-2.0
# 
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
#  KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.

function isGitRepo (){
	local dir=$1

	cd $dir
	local rv="false"
	if [ -d .git ];then
		rv="true"
	fi
	cd -
	echo rv
}

function GitInit (){
	local topJsDir=$1

	local gitignore="./platforms/pebble/strapkit/aux/.gitignore"

	local topJsRepoStatus=$(isGitRepo $topJsDir)
	if [  "$topJsRepoStatus" != "true" ];then
		cd $topJsDir
		git init
		echo "gitignore: $gitignore"
		cp $gitignore .
		cd -
	fi

	local internalJSDir=$2
	
	local internalJSRepoStatus=$(isGitRepo $internalJSDir)
	if [ "$internalJSRepoStatus" != "true" ];then
		cd $internalJSDir
		git init
		git remote add origin $topJsDir
		cd -
	fi
}

function AddCommit (){
	local jsDir=$1
	cd $jsDir
	git add .
	git commit -m "saving top level js dir changes"
	cd -
}			

function PullChangesTo (){
	local pebbleSrcJs=$1
	cd $pebbleSrcJs
	git fetch origin master:new
	git merge --commit -m "pull changes from top level js dir" new
	git branch -d new
	cd -
}

function SyncDirContents (){
	local indexDir=$1
	local appDir=$2
	AddCommit $indexDir
	PullChangesTo $appDir
}

function PebbleBuild (){
	local pebbleproj=$1
	cd $pebbleproj
	pebble build
}

STRAPKIT_PATH=$( cd "$( dirname "$0" )" && pwd -P)
PROJECT_PATH="$(dirname "$STRAPKIT_PATH")"
PROJECT_NAME=$( basename $( pwd -P ) )

indexDir="./js/*"
appDir="./platforms/pebble/$PROJECT_NAME/src/js/"
pblProj="./platforms/pebble/$PROJECT_NAME"

SyncDirContents $indexDir $appDir
PebbleBuild $pblProj

# rename index to app
# indexjs="./platforms/pebble/$PROJECT_NAME/src/js/index.js"
# appjs="./platforms/pebble/$PROJECT_NAME/src/js/app.js"
# mv $indexjs $appjs